# FEEDBACK
## Active Record
AR для меня антипаттерн, использования которого я категорически избегаю. Если на проекте он уже есть, то применяю ряд мер, чтобы максимально изолировать его использование и привести к какому-то подобию модели.  О причинах можно спросить устно.

Как минимум для записи AR не должен использоваться, в вашем кейсе AR-модели только для чтения используется, поэтому сойдет и так.

## AR-модели как комбаин с излишней ответственностью.
Модели здесь это одновременно и DTO моделирующие получаемый объект, и непосредственно в БД лазят, и переводом занимаются почему-то. Не гнушается модель и сервис-локатором прямо внутри себя пользоваться.
Все это одна большая архитектурная беда.

Что сделано:
- Вся логика i18n убрана из моделей в представления, где им и место
- Методы доступа к БД убраны в репозиторий `HistoryRecordsRepository`
- Я бы еще убрал все взаимодействие с AR через магию, заменил бы на явные геттеры. Но оставил так 
- Был бы тут доменный слой, тогда я бы AR полностью бы скрыл внутри репозитория

## Спагетти с типами логируемых событий.
   Огромные switch-case в разных местах, в шаблонах, по кейсу на каждое событие.

Что сделано:
- Для каждого типа событий сделан моделирующий его класс. См. `app\models\history\events\EventInterface`
- С помощью фабрики `app\models\history\events\EventFactory` можно из объекта `History` получить типизированную модель события.
- Фабрика создает нужное событие на основе конфигурационного файла `app/config/events.php` 
- Фабрику событий мы достаем из DI-контейнера в нужных виджетах, внутри виджетов работаем с универсальным абстрактным событием вместо обработки каждого типа события в switch-else
- Для отображения списка сделаны шаблоны для каждого из типов событий

## Проблема с большим объемом экспортируемых данных
Касаемо экспорта, я вижу 2 пути оптимизации:
   - Техническая: выборка исключительно тех данных, которые нужны для формирования отчета для сокращения использования памяти.
   - Организационная: ограничение максимального периода времени за которое возможен экспорт данных. Маловероятно, что полный экспорт всех данных целесообразен. Можно добавить формочку с выбором периода в интерфейс и соответствующую логику.

Что сделано:
- Создание data provider для отображения списка и для экспорта разделено на два отдельных метода в репозитории `HistoryRecordsRepository`.
- Для отображения списка не требуется что-либо оптимизировать, так как объем данных не большой.
- А во втором методе для экспорта, запрос составлен таким образом, чтобы выбирались только те поля данных, которые идут в экспортируеую таблицу. Как минимум память поэкономит.
- Второй метод я не стал реализовывать, так как и так времени потратил достаточно на задание

## Нерабочий перевод
- Во-первых, прямо в модельках дергается сервис локатор для доступка к компоненту перевода
- Во-вторых, строки формировались прямо в моделях и за счет этого, куски вроде переведены, а куски нет.
- В-третьих, вообще не настроен компонент переводов

Что сделано:
    - Компонент переводов настроил
    - Из моделей всю логику переводов поубирал, перенес в представление
    - Строки собираются не в моделях, а с помощью шаблонов в файлах переводов (`messages/en-US/events.php`) через стандартные средства Yii

## Много запросов на главной
Страничка со списком при каждом обращении делает 20 запросов к БД, из которых большая часть - запросы метаданных таблиц. Хотя я вообщем-то вижу у вас в конфиге закомменченный кэш и настройки.

Что сделано:
    - Настроил кэш

## Неясная модель `HistorySearch`.
Вероятно это для критериев поиска?  
Я вижу, что gii генерирует такой класс по умолчанию, но по мне это никуда не годится.
- Во-перых, критериев нет - можно удалить класс
- Во-вторых, зачем DTO с критериями наследовать от самой модели?
- В-третьих, что в модели делает доступ к объекту Request и его параметры через сервис локатор
- В четвертых, что в модели делает логика доступа к БД

Что-сделано:
    - Если воспринимать эту модель как модель критериев поиска, то унаследовать её от CModel.
    - И то, только потому, что в Yii, кажется, компонент валидатора работает только из модели
    - Убрал оттуда доступ к БД в репозиторий
    - Больше ничего не делал
